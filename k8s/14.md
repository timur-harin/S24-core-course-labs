# Lab14

## Description of components

```text
1. Prometheus: It's a powerful open-source monitoring and alerting toolkit. It collects metrics from configured targets using a pull model, storing them in a time series database. It then provides an HTTP API for read and write operations. It also provides a web UI for exploring the collected metrics.
2. Prometheus Node Exporter: This is a simple, lightweight service that collects metrics about the underlying machine's resources. It's often used in Kubernetes clusters to expose metrics about each node in the cluster.
3. Prometheus Adapter for Kubernetes Metrics APIs: This adapter allows the Kubernetes Metrics API to be used with Prometheus. It translates the metrics that Prometheus collects into a format that the Metrics API can understand.
4. kube-state-metrics: This component generates metrics about the state of various objects in a Kubernetes cluster. It exposes these metrics in a format that can be scraped by Prometheus to monitor the health and performance of the cluster.
5. Grafana: Grafana is a popular open-source platform for monitoring and observability. It allows you to query, visualize, alert on, and understand your metrics no matter where they are stored. It's often used alongside Prometheus to create dashboards and visualizations of the collected metrics.
6. Alertmanager: Alertmanager is a component that handles alerts sent by client applications such as Prometheus. It takes care of deduplicating, grouping, and routing these alerts to the correct receiver (email, Slack, etc.) based on their labels and annotations.
7. Prometheus Operator: This is a Kubernetes operator that simplifies the deployment and management of Prometheus instances in a Kubernetes cluster. It follows best practices for running Prometheus in a Kubernetes environment, such as managing configuration, scaling, and updates automatically.
```

## Installation

```bash
kubectl get po,sts,svc,pvc,cm
```

```bash
NAME                                                         READY   STATUS    RESTARTS   AGE
pod/alertmanager-monitoring-kube-prometheus-alertmanager-0   2/2     Running   0          7m43s
pod/monitoring-grafana-657659866f-kr8db                      3/3     Running   0          8m7s
pod/monitoring-kube-prometheus-operator-b57d5fdb4-flmtr      1/1     Running   0          8m7s
pod/monitoring-kube-state-metrics-ff67df946-7xspk            1/1     Running   0          8m7s
pod/monitoring-prometheus-node-exporter-2mf5m                1/1     Running   0          8m7s
pod/prometheus-monitoring-kube-prometheus-prometheus-0       2/2     Running   0          7m43s
pod/python-app-0                                          1/1     Running   0          7m6s
pod/python-app-1                                          1/1     Running   0          7m6s

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-monitoring-kube-prometheus-alertmanager   1/1     7m43s
statefulset.apps/prometheus-monitoring-kube-prometheus-prometheus       1/1     7m43s
statefulset.apps/python-app                                          2/2     7m6s

NAME                                              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                     ClusterIP   None             <none>        9093/TCP,9094/TCP,9094/UDP   7m43s
service/kubernetes                                ClusterIP   10.96.0.1        <none>        443/TCP                      33m
service/monitoring-grafana                        ClusterIP   10.100.0.98      <none>        80/TCP                       8m7s
service/monitoring-kube-prometheus-alertmanager   ClusterIP   10.104.171.162   <none>        9093/TCP,8080/TCP            8m7s
service/monitoring-kube-prometheus-operator       ClusterIP   10.97.214.200    <none>        443/TCP                      8m7s
service/monitoring-kube-prometheus-prometheus     ClusterIP   10.106.250.226   <none>        9090/TCP,8080/TCP            8m7s
service/monitoring-kube-state-metrics             ClusterIP   10.108.209.168   <none>        8080/TCP                     8m7s
service/monitoring-prometheus-node-exporter       ClusterIP   10.102.229.26    <none>        9100/TCP                     8m7s
service/prometheus-operated                       ClusterIP   None             <none>        9090/TCP                     7m43s
service/python-app                             ClusterIP   10.110.165.46    <none>        8080/TCP                     7m6s

NAME                                          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/data-flutter-app-0   Bound    pvc-8c69a243-eaf3-41ea-90b0-9b13c4ab59b4   1Gi        RWO            standard       32m
persistentvolumeclaim/data-flutter-app-1   Bound    pvc-5ac63ca2-e5d6-4233-a2ab-f783f3f005f7   1Gi        RWO            standard       32m
persistentvolumeclaim/data-python-app-0    Bound    pvc-31f33c0b-209d-4b6f-a1b6-6699f72fd1c2   1Gi        RWO            standard       7m6s
persistentvolumeclaim/data-python-app-1    Bound    pvc-eae487a1-19ac-4e9a-b12f-c4712b61bd60   1Gi        RWO            standard       7m6s

NAME                                                                     DATA   AGE
configmap/config                                                         1      7m6s
configmap/kube-root-ca.crt                                               1      32m
configmap/monitoring-grafana                                             1      8m7s
configmap/monitoring-grafana-config-dashboards                           1      8m7s
configmap/monitoring-kube-prometheus-alertmanager-overview               1      8m7s
configmap/monitoring-kube-prometheus-apiserver                           1      8m7s
configmap/monitoring-kube-prometheus-cluster-total                       1      8m7s
configmap/monitoring-kube-prometheus-controller-manager                  1      8m7s
configmap/monitoring-kube-prometheus-etcd                                1      8m7s
configmap/monitoring-kube-prometheus-grafana-datasource                  1      8m7s
configmap/monitoring-kube-prometheus-grafana-overview                    1      8m7s
configmap/monitoring-kube-prometheus-k8s-coredns                         1      8m7s
configmap/monitoring-kube-prometheus-k8s-resources-cluster               1      8m7s
configmap/monitoring-kube-prometheus-k8s-resources-multicluster          1      8m7s
configmap/monitoring-kube-prometheus-k8s-resources-namespace             1      8m7s
configmap/monitoring-kube-prometheus-k8s-resources-node                  1      8m7s
configmap/monitoring-kube-prometheus-k8s-resources-pod                   1      8m7s
configmap/monitoring-kube-prometheus-k8s-resources-workload              1      8m7s
configmap/monitoring-kube-prometheus-k8s-resources-workloads-namespace   1      8m7s
configmap/monitoring-kube-prometheus-kubelet                             1      8m7s
configmap/monitoring-kube-prometheus-namespace-by-pod                    1      8m7s
configmap/monitoring-kube-prometheus-namespace-by-workload               1      8m7s
configmap/monitoring-kube-prometheus-node-cluster-rsrc-use               1      8m7s
configmap/monitoring-kube-prometheus-node-rsrc-use                       1      8m7s
configmap/monitoring-kube-prometheus-nodes                               1      8m7s
configmap/monitoring-kube-prometheus-nodes-darwin                        1      8m7s
configmap/monitoring-kube-prometheus-persistentvolumesusage              1      8m7s
configmap/monitoring-kube-prometheus-pod-total                           1      8m7s
configmap/monitoring-kube-prometheus-prometheus                          1      8m7s
configmap/monitoring-kube-prometheus-proxy                               1      8m7s
configmap/monitoring-kube-prometheus-scheduler                           1      8m7s
configmap/monitoring-kube-prometheus-workload-total                      1      8m7s
configmap/prometheus-monitoring-kube-prometheus-prometheus-rulefiles-0   35     7m43s
```

Summary:
- Four pods were installed for your Python and Flutter applications, along with other pods from kube-prometheus
- Two stateful sets were installed, one from kube-prometheus and one from each of your applications;
- Multiple services were allocated, with most of them coming from kube-prometheus, but two are specific to your applications;
- Persistent volumes were allocated for each of your application pods, with one volume per pod;
- Config maps were installed, all of which are from kube-prometheus.


# Answers
1. CPU consumption: 2%, memory consumption: 40MiB
2. kube-apiserver has the highest CPU usage,  app-python has the lowest CPU usage. 1.3% vs 0.01%
3. Memory usage: 6,1GB; 38%
4. I have 15 pods and 22 containers
5. Approximately 50kB/s download, 150kB/s upload
6. 8 alerts

## App metrics

![](./assets/dashboard_prometheus.png)

![](./assets/metrics.png)



```bash
kubectl exec -it python-app-python-chart-b6755dddb-jmpdq -- sh
```

```bash
Defaulted container "python-app" out of: python-app, vault-agent, vault-agent-init (init)
cat /vault/secrets/database-config.txt 
```

```bash
postgresql://db-readonly-username:db-secret-password@postgres:5432
```


```bash
kubectl exec -it python-app-python-chart-b6755dddb-jmpdq -- cat init-container/queue
```

```bash
Defaulted container "python-app" out of: python-app, init-example (init), init-queue-2 (init), init-queue-3 (init)
```
