# Tasks for 11th lab

## Task1

### Create secret

```bash
kubectl create secret generic my-secret --from-literal=password='myStrongPassword'
```

```bash 
secret/my-secret created
```

### Verify

```bash
kubectl describe secrets/my-secret 
```

```bash
Name:         my-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  16 bytes
```

### Decode

```bash
kubectl get secrets/my-secret -o jsonpath='{.data.password}' | base64 -d
```

```bash
myStrongPassword%
```

### Create env secret

Using 
```bash
 sops -P CBD96CA823E2D03B93CD4FFDA3D75AB941D85637 secrets.yaml          
 ```

![](./assets/strange_encryption.png)

And then solve some enviroment errors to see

![](./assets/solve_helm_secrets.png)

### Run

```bash
helm secrets install python-chart ./python-chart -f ./secrets.yaml
```

```bash
NAME: python-chart
LAST DEPLOYED: Wed Apr 17 10:50:12 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-chart,app.kubernetes.io/instance=python-chart" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
./secrets.yaml.dec
```

### Get po

```bash
kubectl get po
```

```bash
NAME                                         READY   STATUS      RESTARTS        AGE
flutter-app-flutter-chart-6885df768c-clrgh   1/1     Running     1 (3h57m ago)   5h49m
post-install-hook                            0/1     Completed   0               2m47s
pre-install-hook                             0/1     Completed   0               2m52s
python-chart-f487dcc77-ml465                 1/1     Running     0               2m47s
```

### Printenv

```bash
kubectl exec python-chart-f487dcc77-ml465 -- printenv | grep MY_PASSWORD  
```

```bash
MY_PASSWORD=myStrongPassword
```

![](./assets/env_variable.png)

## Task2

### Install

```bash
kubectl get pods
```

```bash
NAME                                         READY   STATUS      RESTARTS       AGE
flutter-app-flutter-chart-6885df768c-clrgh   1/1     Running     1 (4h3m ago)   5h55m
post-install-hook                            0/1     Completed   0              8m59s
pre-install-hook                             0/1     Completed   0              9m4s
python-chart-f487dcc77-ml465                 1/1     Running     0              8m59s
vault-0                                      1/1     Running     0              2m38s
vault-agent-injector-6d57d65964-4mjr2        1/1     Running     0              2m38s
```

### Check

```bash
kubectl exec -it python-app-python-chart-85ddbb759c-rkcfn -- sh
```

```bash
Defaulted container "python-chart" out of: python-chart, vault-agent, vault-agent-init (init)
$ cat /vault/secrets/database-config.txt 
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2024-04-17T10:37:46.683424017Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

```bash
df -h
```

```bash
Filesystem      Size  Used Avail Use% Mounted on
overlay          17G  2.0G   14G  13% /
tmpfs            64M     0   64M   0% /dev
shm              64M     0   64M   0% /dev/shm
tmpfs           256M  4.0K  256M   1% /vault/secrets
/dev/vdb1        17G  2.0G   14G  13% /etc/hosts
tmpfs           256M   12K  256M   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           1.9G     0  1.9G   0% /proc/asound
tmpfs           1.9G     0  1.9G   0% /proc/acpi
tmpfs           1.9G     0  1.9G   0% /sys/firmware
```

### After template

```bash
kubectl exec -it python-app-python-chart-b6755dddb-jmpdq -- sh
```

```bash
Defaulted container "python-chart" out of: python-chart, vault-agent, vault-agent-init (init)
$ cat /vault/secrets/database-config.txt 
postgresql://db-readonly-username:db-secret-password@postgres:5432
```

## Bonus

The same env for flutter

```bash
helm secrets install flutter-chart ./flutter-chart -f ./secrets.yaml
```

```bash
NAME: flutter-chart
LAST DEPLOYED: Web Apr 17 10:55:24 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=flutter-chart,app.kubernetes.io/instance=flutter-chart" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
./secrets.yaml.dec
```

```bash
kubectl exec flutter-chart-54549cc578-rbr5z -- printenv | grep MY_PASSWORD  
```

```bash
MY_PASSWORD=myStrongPassword
```

Setup limits

![](./assets/limits.png)

Add envs

![](./assets/envs.png)
